{% extends 'partials/base.twig' %}
{% block content %}
    <div id="main-content" class="container-fluid">
        <div class="columns">
            <div class="column is-12">
                <section class="section is-small mt-6">
                    <nav class="breadcrumb " aria-label="breadcrumbs">
                        <ul>
                            <li><a class="is-size-5 has-text-link">Home</a></li>
                            <li><a class="is-size-5 has-text-link">{{ title }}</a></li>
                        </ul>
                    </nav>

                    <div class="columns">
                        <div class="column is-full">
                            <div class="box">
                                <div class="level mb-4">
                                    <div class="level-left">
                                        <button class="button is-rounded is-success" onclick="openModal('addModal')">
                                            <span class="mdi mdi-plus-thick"></span>
                                            Add
                                        </button>
                                        <button class="button is-rounded is-outlined is-primary ml-2" onclick="exportToExcel()">
                                            <span class="mdi mdi-file-excel "></span>
                                            Excel
                                        </button>
                                    </div>
                                </div>

                                {% if errors|length > 0 %}
                                    <div class="notification is-danger" id="errorNotification">
                                        <ul>
                                            {% for error in errors %}
                                                <li>{{ error }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}

                                {% if success %}
                                    <div class="notification is-success" id="successNotification">
                                        {{ success }}
                                    </div>
                                {% endif %}

                                <div class="table-container">
                                    <table id="myTable" class="table is-fullwidth is-hoverable is-striped is-bordered is-narrow">
                                        <thead>
                                        <tr class="is-size-7">
                                            <th>Employee Name</th>
                                            <th>Pay Amount</th>
                                            <th>Account Number</th>
                                            <th>Bank Name</th>
                                            <th>Branch Name</th>
                                            <th>Status</th>
                                            <th>Edit</th>
                                            <th>Freeze</th>
                                            <th>Delete</th>
                                            <th>Pay</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% if payrolls | length > 0 %}
                                            {% for item in payrolls %}
                                                <tr class="{{ item.status == 'frozen' ? 'has-background-danger-dark has-text-white' : '' }}">
                                                    <td>
                                                        {% set emp = employees | filter(e => e.id == item.employee_id) | first %}
                                                        {{ emp ? emp.name : 'N/A' }}
                                                    </td>
                                                    <td>K{{item.net_pay | number_format(2,'.',',')}}</td>
                                                    <td>{{ item.account_number }}</td>
                                                    <td>{{ item.bank_name }}</td>
                                                    <td>{{ item.branch_name }}</td>
                                                    <td>{{ item.status | capitalize }}</td>

                                                    {% if item.status != 'frozen' %}
                                                        <td>
                                                            <button class="button is-small is-info" onclick="openModal('editModal-{{ item.id }}')">
                                                                <span class="mdi mdi-pencil"></span>
                                                            </button>
                                                        </td>
                                                        <td>
                                                            <!-- Suspend button -->
                                                            <button class="button is-small is-primary" onclick="openModal('suspendModal-{{ item.id }}')">
                                                                <span class="mdi mdi-sync-off"></span>
                                                            </button>
                                                        </td>
                                                        <td>
                                                            <button class="button is-small is-danger" onclick="openModal('deleteModal-{{ item.id }}')">
                                                                <span class="mdi mdi-delete"></span>
                                                            </button>
                                                        </td>
                                                        <td>
                                                            <!-- Pay individually -->
                                                            <button type="button" class="button is-small is-success" onclick="openModal('payModal-{{ item.id }}')">
                                                                <span class="mdi mdi-cash"></span> Pay
                                                            </button>

                                                        </td>
                                                    {% else %}
                                                        <td>{{ '-' }}</td>
                                                        <td>
                                                            {% if item.status == 'frozen' %}
                                                                <!-- Activate button -->
                                                                <button class="button is-small is-success" onclick="openModal('activateModal-{{ item.id }}')">
                                                                    <span class="mdi mdi-sync-circle"></span>
                                                                </button>
                                                            {% else %}
                                                                <!-- Suspend button -->
                                                                <button class="button is-small is-primary" onclick="openModal('suspendModal-{{ item.id }}')">
                                                                    <span class="mdi mdi-sync-off"></span>
                                                                </button>
                                                            {% endif %}
                                                        </td>
                                                        <td>{{ '-' }}</td>
                                                    {% endif %}

                                                </tr>

                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="12" class="has-text-centered">No payroll records found.</td>
                                            </tr>
                                        {% endif %}
                                        </tbody>
                                    </table>
                                    {% if payrolls | length > 0 %}
                                        <div class="has-text-right mt-4">
                                            <button type="button" class="button is-link is-medium is-focused" onclick="openModal('bankModal')">
                                                <span class="mdi mdi-bank-transfer is-size-3"></span> Pay All
                                            </button>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Bank Modal -->
                                <div id="bankModal" class="modal">
                                    <div class="modal-background"></div>
                                    <div class="modal-card">
                                        <header class="modal-card-head has-background-warning">
                                            <p class="modal-card-title has-text-white">Pay All</p>
                                            <button class="delete" aria-label="close" onclick="closeModal('bankModal')"></button>
                                        </header>
                                        <section class="modal-card-body">
                                            <p>
                                                Are you sure you want to initiate payment of all salaries?
                                            </p>
                                        </section>
                                        <footer class="modal-card-foot">
                                            <form action="/payroll/pay-all" method="post">
                                                <button type="submit" class="button is-rounded is-success">
                                                    <span class="mdi mdi-bank-transfer mr-1"></span> Pay
                                                </button>
                                                <button type="button" class="button is-rounded" onclick="closeModal('bankModal')">Cancel</button>
                                            </form>
                                        </footer>
                                    </div>
                                </div>

                                {% for item in payrolls  %}
                                    <!-- Edit Modal -->
                                    <div id="editModal-{{ item.id }}" class="modal">
                                        <div class="modal-background"></div>
                                        <div class="modal-card">
                                            <header class="modal-card-head has-background-warning">
                                                <p class="modal-card-title has-text-white">Edit Payroll</p>
                                                <button class="delete" aria-label="close" onclick="closeModal('editModal-{{ item.id }}')"></button>
                                            </header>
                                            <section class="modal-card-body">
                                                <form action="/payroll/update" method="post">
                                                    <input type="hidden" name="payroll_id" value="{{ item.id }}">
                                                    {% include 'partials/payroll_form_fields.twig' with { employee: employees} %}
                                                    <div class="field is-grouped is-grouped-left">
                                                        <p class="control">
                                                            <button type="submit" class="button is-rounded is-success">
                                                                <span class="mdi mdi-account-off mr-1"></span>  Update
                                                            </button>
                                                        </p>
                                                        <p class="control">
                                                            <button type="button" class="button is-rounded " onclick="closeModal('editModal-{{ item.id }}')">Cancel</button>
                                                        </p>
                                                    </div>
                                                </form>
                                            </section>
                                        </div>
                                    </div>

                                    <!-- Individual Pay Confirmation Modal -->
                                    <div id="payModal-{{ item.id }}" class="modal">
                                        <div class="modal-background"></div>
                                        <div class="modal-card">
                                            <header class="modal-card-head has-background-warning">
                                                <p class="modal-card-title has-text-white">Confirm Payment</p>
                                                <button class="delete" aria-label="close" onclick="closeModal('payModal-{{ item.id }}')"></button>
                                            </header>
                                            <section class="modal-card-body">
                                                <p>
                                                    Are you sure you want to initiate
                                                    <strong>
                                                        {% set emp = employees | filter(e => e.id == item.employee_id) | first %}
                                                        {{ emp ? emp.name : 'N/A' }}
                                                    </strong>'s
                                                    salary payment?
                                                </p>
                                            </section>
                                            <footer class="modal-card-foot">
                                                <form action="/payroll/pay/{{ item.id }}" method="post">
                                                    <input class="is-hidden" name="payroll_id" value="{{ item.id }}">
                                                    <button type="submit" class="button is-rounded is-success">
                                                        <span class="mdi mdi-cash mr-1"></span> Pay
                                                    </button>
                                                    <button type="button" class="button is-rounded" onclick="closeModal('payModal-{{ item.id }}')">Cancel</button>
                                                </form>
                                            </footer>
                                        </div>
                                    </div>

                                    <!-- Activate Confirmation Modal -->
                                    <div id="activateModal-{{ item.id }}" class="modal">
                                        <div class="modal-background"></div>
                                        <div class="modal-card">
                                            <header class="modal-card-head has-background-warning">
                                                <p class="modal-card-title has-text-white">Confirm Unfreeze</p>
                                                <button class="delete" aria-label="close" onclick="closeModal('activateModal-{{ item.id }}')"></button>
                                            </header>
                                            <section class="modal-card-body">
                                                <p>
                                                    Are you sure you want to unfreeze
                                                    <strong>
                                                        {% set emp = employees | filter(e => e.id == item.employee_id) | first %}
                                                        {{ emp ? emp.name : 'N/A' }}
                                                    </strong>'s
                                                    payroll record?
                                                </p>
                                            </section>
                                            <footer class="modal-card-foot">
                                                <form action="/payroll/unfreeze" method="post">
                                                    <input class="is-hidden" name="payroll_id" value="{{ item.id }}">
                                                    <button type="submit" class="button is-rounded is-primary">
                                                        <span class="mdi mdi-sync-circle"></span> Unfreeze
                                                    </button>
                                                    <button type="button" class="button is-rounded" onclick="closeModal('activateModal-{{ item.id }}')">Cancel</button>
                                                </form>
                                            </footer>
                                        </div>
                                    </div>

                                    <!-- Suspend Confirmation Modal -->
                                    <div id="suspendModal-{{ item.id }}" class="modal">
                                        <div class="modal-background"></div>
                                        <div class="modal-card">
                                            <header class="modal-card-head has-background-warning">
                                                <p class="modal-card-title has-text-white">Confirm Freeze</p>
                                                <button class="delete" aria-label="close" onclick="closeModal('suspendModal-{{ item.id }}')"></button>
                                            </header>
                                            <section class="modal-card-body">
                                                <p>
                                                    Are you sure you want to freeze
                                                    <strong>
                                                        {% set emp = employees | filter(e => e.id == item.employee_id) | first %}
                                                        {{ emp ? emp.name : 'N/A' }}
                                                    </strong>'s
                                                    payroll record?
                                            </section>
                                            <footer class="modal-card-foot">
                                                <form action="/payroll/freeze" method="post">
                                                    <input class="is-hidden" name="payroll_id" value="{{ item.id }}">
                                                    <button type="submit" class="button is-rounded is-primary">
                                                        <span class="mdi mdi-sync-off mr-1"></span> Freeze
                                                    </button>
                                                    <button type="button" class="button is-rounded" onclick="closeModal('suspendModal-{{ item.id }}')">Cancel</button>
                                                </form>
                                            </footer>
                                        </div>
                                    </div>

                                    <!-- Delete Confirmation Modal -->
                                    <div id="deleteModal-{{ item.id }}" class="modal">
                                        <div class="modal-background"></div>
                                        <div class="modal-card">
                                            <header class="modal-card-head has-background-danger">
                                                <p class="modal-card-title has-text-white">Confirm Deletion</p>
                                                <button class="delete" aria-label="close" onclick="closeModal('deleteModal-{{item.id }}')"></button>
                                            </header>
                                            <section class="modal-card-body">
                                                <p>
                                                    Are you sure you want to delete
                                                    <strong>
                                                        {% set emp = employees | filter(e => e.id == item.employee_id) | first %}
                                                        {{ emp ? emp.name : 'N/A' }}
                                                    </strong>'s
                                                    payroll record?
                                                </p>
                                                <br>
                                                <small></small>
                                            </section>
                                            <footer class="modal-card-foot">
                                                <form action="/payroll/delete" method="post">
                                                    <input class="is-hidden" name="payroll_id" value="{{ item.id }}">
                                                    <button type="submit" class="button is-rounded is-danger">
                                                        <span class="mdi mdi-delete mr-1"></span> Delete
                                                    </button>
                                                    <button  type="button" class="button is-rounded" onclick="closeModal('deleteModal-{{ item.id }}')">Cancel</button>
                                                </form>
                                            </footer>
                                        </div>
                                    </div>
                                {% endfor %}


                                <!-- Add Modal -->
                                <div id="addModal" class="modal">
                                    <div class="modal-background"></div>
                                    <div class="modal-card">
                                        <header class="modal-card-head has-background-warning">
                                            <p class="modal-card-title has-text-white">Add Payroll</p>
                                            <button class="delete" aria-label="close" onclick="closeModal('addModal')"></button>
                                        </header>
                                        <section class="modal-card-body">
                                            <form action="/payroll/add" method="post">
                                                {% include 'partials/payroll_form_fields.twig' with { employee: {}, prefix: 'add' } %}
                                                <div class="field is-grouped is-grouped-left">
                                                    <p class="control">
                                                        <button type="submit" class="button is-rounded is-success">
                                                            <span class="mdi mdi-content-save mr-1"></span>  Save
                                                        </button>
                                                    </p>
                                                    <p class="control">
                                                        <button  type="button" class="button is-rounded" onclick="closeModal('addModal')">Cancel</button>
                                                    </p>
                                                </div>
                                            </form>
                                        </section>
                                    </div>
                                </div>

                                <script>
                                    function openModal(id) {
                                        document.getElementById(id).classList.add('is-active');
                                    }
                                    function closeModal(id) {
                                        document.getElementById(id).classList.remove('is-active');
                                    }
                                    function exportToExcel() {
                                        const table = document.getElementById("myTable");
                                        const data = [];
                                        for (let row of table.rows) {
                                            let rowData = [];
                                            for (let i = 0; i < row.cells.length - 1; i++) {
                                                rowData.push(row.cells[i].innerText);
                                            }
                                            data.push(rowData);
                                        }
                                        const worksheet = XLSX.utils.aoa_to_sheet(data);
                                        const workbook = XLSX.utils.book_new();
                                        XLSX.utils.book_append_sheet(workbook, worksheet, "Employees");
                                        XLSX.writeFile(workbook, "employees.xlsx");
                                    }

                                </script>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
    <script>
        // Disable all form submit buttons after submit
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function() {
                const buttons = form.querySelectorAll('button[type="submit"]');
                buttons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('is-loading'); // Optional Bulma loading spinner
                });
            });
        });

    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            setTimeout(function () {
                const errorNote = document.getElementById('errorNotification');
                const successNote = document.getElementById('successNotification');

                if (errorNote) {
                    errorNote.style.transition = "opacity 0.5s ease";
                    errorNote.style.opacity = 0;
                    setTimeout(() => errorNote.remove(), 500);
                }
                if (successNote) {
                    successNote.style.transition = "opacity 0.5s ease";
                    successNote.style.opacity = 0;
                    setTimeout(() => successNote.remove(), 500);
                }

                // ✅ Reset URL after hiding notifications
                const url = new URL(window.location.href);
                if (url.searchParams.has("success") || url.searchParams.has("error")) {
                    url.searchParams.delete("success");
                    url.searchParams.delete("error");
                    window.history.replaceState({}, document.title, url.toString());
                }
            }, 4000); // delay before fade starts
        });
    </script>

{% endblock %}
